# Title: Log4j RCE CVE-2021-44228 in Fields
# Author: Florian Roth (Nextron Systems)
# Date: 2021-12-10
# Level: high
# Description: Detects exploitation attempt against log4j RCE vulnerability reported as CVE-2021-44228 in different header fields found in web server logs (Log4Shell)
# MITRE Tactic: Initial Access
# Tags: attack.initial-access, attack.t1190, cve.2021-44228, detection.emerging-threats
# False Positives:
#   - Vulnerability scanning

"cs-user-agent" IN ("*${jndi:ldap:/*", "*${jndi:rmi:/*", "*${jndi:ldaps:/*", "*${jndi:dns:/*", "*/$%7bjndi:*", "*%24%7bjndi:*", "*$%7Bjndi:*", "*%2524%257Bjndi*", "*%2F%252524%25257Bjndi%3A*", "*${jndi:${lower:*", "*${::-j}${*", "*${jndi:nis*", "*${jndi:nds*", "*${jndi:corba*", "*${jndi:iiop*", "*Reference Class Name: foo*", "*${${env:BARFOO:-j}*", "*${::-l}${::-d}${::-a}${::-p}*", "*${base64:JHtqbmRp*", "*${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}$*", "*${${lower:j}ndi:*", "*${${upper:j}ndi:*", "*${${::-j}${::-n}${::-d}${::-i}:*") OR "cs-uri-query" IN ("*${jndi:ldap:/*", "*${jndi:rmi:/*", "*${jndi:ldaps:/*", "*${jndi:dns:/*", "*/$%7bjndi:*", "*%24%7bjndi:*", "*$%7Bjndi:*", "*%2524%257Bjndi*", "*%2F%252524%25257Bjndi%3A*", "*${jndi:${lower:*", "*${::-j}${*", "*${jndi:nis*", "*${jndi:nds*", "*${jndi:corba*", "*${jndi:iiop*", "*Reference Class Name: foo*", "*${${env:BARFOO:-j}*", "*${::-l}${::-d}${::-a}${::-p}*", "*${base64:JHtqbmRp*", "*${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}$*", "*${${lower:j}ndi:*", "*${${upper:j}ndi:*", "*${${::-j}${::-n}${::-d}${::-i}:*") OR "cs-referer" IN ("*${jndi:ldap:/*", "*${jndi:rmi:/*", "*${jndi:ldaps:/*", "*${jndi:dns:/*", "*/$%7bjndi:*", "*%24%7bjndi:*", "*$%7Bjndi:*", "*%2524%257Bjndi*", "*%2F%252524%25257Bjndi%3A*", "*${jndi:${lower:*", "*${::-j}${*", "*${jndi:nis*", "*${jndi:nds*", "*${jndi:corba*", "*${jndi:iiop*", "*Reference Class Name: foo*", "*${${env:BARFOO:-j}*", "*${::-l}${::-d}${::-a}${::-p}*", "*${base64:JHtqbmRp*", "*${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}$*", "*${${lower:j}ndi:*", "*${${upper:j}ndi:*", "*${${::-j}${::-n}${::-d}${::-i}:*")