# Title: UNC4841 - Download Tar File From Untrusted Direct IP Via Wget
# Author: Nasreddine Bencherchali (Nextron Systems)
# Date: 2023-06-16
# Level: high
# Description: Detects execution of "wget" to download a "tar" from an IP address that doesn't have a trusted certificate. As seen used by UNC4841 during their Barracuda ESG zero day exploitation.
# MITRE Tactic: Defense Evasion
# Tags: attack.defense-evasion, attack.t1140, detection.emerging-threats

CommandLine="*--no-check-certificate*" CommandLine="*.tar" Image="*/wget" NOT (CommandLine IN ("*https://10.*", "*https://192.168.*", "*https://172.16.*", "*https://172.17.*", "*https://172.18.*", "*https://172.19.*", "*https://172.20.*", "*https://172.21.*", "*https://172.22.*", "*https://172.23.*", "*https://172.24.*", "*https://172.25.*", "*https://172.26.*", "*https://172.27.*", "*https://172.28.*", "*https://172.29.*", "*https://172.30.*", "*https://172.31.*", "*https://127.*", "*https://169.254.*"))
| regex CommandLine="https://[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}"