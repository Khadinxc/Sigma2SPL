# Title: Schtasks Creation Or Modification With SYSTEM Privileges
# Author: Nasreddine Bencherchali (Nextron Systems)
# Date: 2022-07-28
# Level: high
# Description: Detects the creation or update of a scheduled task to run with "NT AUTHORITY\SYSTEM" privileges
# MITRE Tactic: Privilege Escalation
# Tags: attack.privilege-escalation, attack.execution, attack.persistence, attack.t1053.005

CommandLine IN ("* /change *", "* /create *") Image="*\\schtasks.exe" CommandLine="*/ru *" CommandLine IN ("*NT AUT*", "* SYSTEM *") NOT (CommandLine IN ("*/Create /F /RU System /SC WEEKLY /TN AviraSystemSpeedupVerify /TR *", "*:\\Program Files (x86)\\Avira\\System Speedup\\setup\\avira_speedup_setup.exe*", "*/VERIFY /VERYSILENT /NOSTART /NODOTNET /NORESTART\" /RL HIGHEST*") OR (CommandLine="*Subscription Heartbeat*" CommandLine="*\\HeartbeatConfig.xml*" CommandLine="*\\Microsoft Shared\\OFFICE*") OR (CommandLine="*/TN TVInstallRestore*" CommandLine="*\\TeamViewer_.exe*" Image="*\\schtasks.exe"))