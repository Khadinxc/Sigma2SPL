# Title: Scheduled Task Executing Payload from Registry
# Author: X__Junior (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)
# Date: 2023-07-18
# Level: medium
# Description: Detects the creation of a schtasks that potentially executes a payload stored in the Windows Registry using PowerShell.
# MITRE Tactic: Privilege Escalation
# Tags: attack.privilege-escalation, attack.execution, attack.persistence, attack.t1053.005, attack.t1059.001

CommandLine="*/Create*" CommandLine IN ("*Get-ItemProperty*", "* gp *") CommandLine IN ("*HKCU:*", "*HKLM:*", "*registry::*", "*HKEY_*") Image="*\\schtasks.exe" OR OriginalFileName="schtasks.exe" NOT (CommandLine IN ("*FromBase64String*", "*encodedcommand*"))