# Title: Scheduled TaskCache Change by Uncommon Program
# Author: Syed Hasan (@syedhasan009)
# Date: 2021-06-18
# Level: high
# Description: Monitor the creation of a new key under 'TaskCache' when a new scheduled task is registered by a process that is not svchost.exe, which is suspicious
# MITRE Tactic: Privilege Escalation
# Tags: attack.privilege-escalation, attack.execution, attack.persistence, attack.t1053, attack.t1053.005

TargetObject="*SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\*" NOT (Details="(Empty)" OR (Image="C:\\Windows\\explorer.exe" TargetObject="*\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\Microsoft\\Windows\\PLA\\Server Manager Performance Monitor\\*") OR Image="*C:\\Windows\\System32\\MoUsoCoreWorker.exe" OR Image="C:\\Windows\\System32\\msiexec.exe" OR (Image="*\\ngen.exe" Image="C:\\Windows\\Microsoft.NET\\Framework*" TargetObject IN ("*\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\{B66B135D-DA06-4FC4-95F8-7458E1D10129}*", "*\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\Microsoft\\Windows\\.NET Framework\\.NET Framework NGEN*")) OR NOT Details=* OR Image IN ("C:\\Program Files\\Microsoft Office\\root\\Integration\\Integrator.exe", "C:\\Program Files (x86)\\Microsoft Office\\root\\Integration\\Integrator.exe", "C:\\Program Files\\Common Files\\microsoft shared\\ClickToRun\\OfficeC2RClient.exe", "C:\\Program Files (x86)\\Common Files\\microsoft shared\\ClickToRun\\OfficeC2RClient.exe") OR TargetObject IN ("*Microsoft\\Windows\\UpdateOrchestrator*", "*Microsoft\\Windows\\SoftwareProtectionPlatform\\SvcRestartTask\\Index*", "*Microsoft\\Windows\\Flighting\\OneSettings\\RefreshCache\\Index*") OR Image="C:\\Windows\\System32\\RuntimeBroker.exe" OR Image="*C:\\Windows\\System32\\services.exe" OR Image="C:\\WINDOWS\\system32\\svchost.exe" OR Image="System" OR (Image="*\\TiWorker.exe" Image="C:\\Windows\\*")) NOT (Image IN ("C:\\Program Files (x86)\\Dropbox\\Update\\DropboxUpdate.exe", "C:\\Program Files\\Dropbox\\Update\\DropboxUpdate.exe") OR Image IN ("*C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\MicrosoftEdgeUpdate.exe", "*C:\\Program Files\\Microsoft\\EdgeUpdate\\MicrosoftEdgeUpdate.exe") OR Image IN ("*C:\\Program Files (x86)\\Microsoft OneDrive\\OneDrive.exe", "*C:\\Program Files\\Microsoft OneDrive\\OneDrive.exe"))