# Title: Common Autorun Keys Modification
# Author: Victor Sergeev, Daniil Yugoslavskiy, Gleb Sukhodolskiy, Timur Zinniatullin, oscd.community, Tim Shelton, frack113 (split), wagga (name)
# Date: 2019-10-25
# Level: medium
# Description: Detects modification of autostart extensibility point (ASEP) in registry.
# MITRE Tactic: Privilege Escalation
# Tags: attack.privilege-escalation, attack.persistence, attack.t1547.001
# False Positives:
#   - Legitimate software automatically (mostly, during installation) sets up autorun keys for legitimate reason
#   - Legitimate administrator sets up autorun keys for legitimate reason

TargetObject IN ("*\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows CE Services\\AutoStart*", "*\\Software\\Wow6432Node\\Microsoft\\Command Processor\\Autorun*", "*\\SOFTWARE\\Wow6432Node\\Microsoft\\Active Setup\\Installed Components*", "*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnDisconnect*", "*\\SOFTWARE\\Microsoft\\Windows CE Services\\AutoStartOnConnect*", "*\\SYSTEM\\Setup\\CmdLine*", "*\\Software\\Microsoft\\Ctf\\LangBarAddin*", "*\\Software\\Microsoft\\Command Processor\\Autorun*", "*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components*", "*\\SOFTWARE\\Classes\\Protocols\\Handler*", "*\\SOFTWARE\\Classes\\Protocols\\Filter*", "*\\SOFTWARE\\Classes\\Htmlfile\\Shell\\Open\\Command\\(Default)*", "*\\Environment\\UserInitMprLogonScript*", "*\\SOFTWARE\\Policies\\Microsoft\\Windows\\Control Panel\\Desktop\\Scrnsave.exe*", "*\\Software\\Microsoft\\Internet Explorer\\UrlSearchHooks*", "*\\SOFTWARE\\Microsoft\\Internet Explorer\\Desktop\\Components*", "*\\Software\\Classes\\Clsid\\{AB8902B4-09CA-4bb6-B78D-A8F59079A8D5}\\Inprocserver32*", "*\\Control Panel\\Desktop\\Scrnsave.exe*") NOT (Details="(Empty)" OR NOT Details=* OR Image="C:\\Windows\\System32\\poqexec.exe") NOT (TargetObject="*\\Software\\Microsoft\\Active Setup\\Installed Components\\{89820200-ECBD-11cf-8B85-00AA005B4383}*" OR TargetObject="*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\{8A69D345-D564-463c-AFF1-A69D9E530F96}*" OR TargetObject="*\\SOFTWARE\\Microsoft\\Active Setup\\Installed Components\\{9459C573-B17A-45AE-9F64-1857B5D58CEE}*" OR Image IN ("C:\\Program Files (x86)\\Microsoft Office\\root\\integration\\integrator.exe", "C:\\Program Files\\Microsoft Office\\root\\integration\\integrator.exe") OR TargetObject IN ("*\\Office\\ClickToRun\\REGISTRY\\MACHINE\\Software\\Classes\\PROTOCOLS\\Handler\\*", "*\\ClickToRunStore\\HKMU\\SOFTWARE\\Classes\\PROTOCOLS\\Handler\\*") OR Details IN ("{314111c7-a502-11d2-bbca-00c04f8ec294}", "{3459B272-CC19-4448-86C9-DDC3B4B2FAD3}", "{42089D2D-912D-4018-9087-2B87803E93FB}", "{5504BE45-A83B-4808-900A-3A5C36E7F77A}", "{807583E5-5146-11D5-A672-00B0D022E945}") OR (Image="*\\OfficeClickToRun.exe" Image IN ("C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\*", "C:\\Program Files\\Common Files\\Microsoft Shared\\ClickToRun\\Updates\\*")))