# Title: HackTool - Evil-WinRm Execution - PowerShell Module
# Author: Nasreddine Bencherchali (Nextron Systems)
# Date: 2024-02-25
# Level: high
# Description: Detects the execution of Evil-WinRM via PowerShell Module logs by leveraging the hardcoded strings inside the utility.
# MITRE Tactic: Lateral Movement
# Tags: attack.lateral-movement

ContextInfo IN ("*:\\Windows\\System32\\wsmprovhost.exe*", "*:\\Windows\\SysWOW64\\wsmprovhost.exe*") Payload IN ("*value=\"(get-location).path*", "*value=\"(get-item*).length*", "*Invoke-Binary *", "*Donut-Loader -process_id*-donutfile*", "*Bypass-4MSI*", "*IEX ([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String($a))).replace('***','')*") OR (Payload="*$servicios = Get-ItemProperty \"registry::HKLM\\System\\CurrentControlSet\\Services\\\"*" Payload="*Where-Object {$_.imagepath -notmatch \"system\" -and $_.imagepath -ne $null } | Select-Object pschildname,imagepath*") OR (Payload="*$a +=  \\\"$($_.FullName.Replace('\\','/'))/\\\"}else{  $a += \\\"$($_.FullName.Replace('\\', '/'))\\\" }*" Payload="*$a=@();$*")