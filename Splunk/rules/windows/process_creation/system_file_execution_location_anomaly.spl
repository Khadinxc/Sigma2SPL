# Title: System File Execution Location Anomaly
# Author: Florian Roth (Nextron Systems), Patrick Bareiss, Anton Kutepov, oscd.community, Nasreddine Bencherchali (Nextron Systems)
# Date: 2017-11-27
# Level: high
# Description: Detects the execution of a Windows system binary that is usually located in the system folder from an uncommon location.
# MITRE Tactic: Defense Evasion
# Tags: attack.defense-evasion, attack.t1036

Image IN ("*\\atbroker.exe", "*\\audiodg.exe", "*\\bcdedit.exe", "*\\bitsadmin.exe", "*\\certreq.exe", "*\\certutil.exe", "*\\cmstp.exe", "*\\conhost.exe", "*\\consent.exe", "*\\cscript.exe", "*\\csrss.exe", "*\\dashost.exe", "*\\defrag.exe", "*\\dfrgui.exe", "*\\dism.exe", "*\\dllhost.exe", "*\\dllhst3g.exe", "*\\dwm.exe", "*\\eventvwr.exe", "*\\finger.exe", "*\\logonui.exe", "*\\LsaIso.exe", "*\\lsass.exe", "*\\lsm.exe", "*\\msiexec.exe", "*\\ntoskrnl.exe", "*\\powershell_ise.exe", "*\\powershell.exe", "*\\pwsh.exe", "*\\regsvr32.exe", "*\\rundll32.exe", "*\\runonce.exe", "*\\RuntimeBroker.exe", "*\\schtasks.exe", "*\\services.exe", "*\\sihost.exe", "*\\smartscreen.exe", "*\\smss.exe", "*\\spoolsv.exe", "*\\svchost.exe", "*\\taskhost.exe", "*\\taskhostw.exe", "*\\Taskmgr.exe", "*\\userinit.exe", "*\\werfault.exe", "*\\werfaultsecure.exe", "*\\wininit.exe", "*\\winlogon.exe", "*\\winver.exe", "*\\wlanext.exe", "*\\wscript.exe", "*\\wsl.exe", "*\\wsmprovhost.exe") NOT (Image IN ("C:\\$WINDOWS.~BT\\*", "C:\\$WinREAgent\\*", "C:\\Windows\\SoftwareDistribution\\*", "C:\\Windows\\System32\\*", "C:\\Windows\\SystemTemp\\*", "C:\\Windows\\SysWOW64\\*", "C:\\Windows\\uus\\*", "C:\\Windows\\WinSxS\\*") OR (Image IN ("*C:\\Program Files\\PowerShell\\7\\*", "*C:\\Program Files\\PowerShell\\7-preview\\*", "*C:\\Program Files\\WindowsApps\\Microsoft.PowerShellPreview*", "*\\AppData\\Local\\Microsoft\\WindowsApps\\Microsoft.PowerShellPreview*") Image="*\\pwsh.exe") OR (Image="*\\AppData\\Local\\Microsoft\\WindowsApps\\*" Image="*\\wsl.exe" Image="C:\\Users\\'*") OR (Image="*\\wsl.exe" Image IN ("C:\\Program Files\\WindowsApps\\MicrosoftCorporationII.WindowsSubsystemForLinux*", "C:\\Program Files\\WSL\\*"))) NOT Image="*\\SystemRoot\\System32\\*"