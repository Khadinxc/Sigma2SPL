# Title: Non-privileged Usage of Reg or Powershell
# Author: Teymur Kheirkhabarov (idea), Ryan Plas (rule), oscd.community
# Date: 2020-10-05
# Level: high
# Description: Search for usage of reg or Powershell by non-privileged users to modify service configuration in registry
# MITRE Tactic: Persistence
# Tags: attack.persistence, attack.defense-evasion, attack.t1112

(CommandLine="*reg *" CommandLine="*add*") OR CommandLine IN ("*powershell*", "*set-itemproperty*", "* sp *", "*new-itemproperty*") CommandLine IN ("*ImagePath*", "*FailureCommand*", "*ServiceDLL*") CommandLine="*ControlSet*" CommandLine="*Services*" IntegrityLevel IN ("Medium", "S-1-16-8192")