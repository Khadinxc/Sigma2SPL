# Title: Webshell Detection With Command Line Keywords
# Author: Florian Roth (Nextron Systems), Jonhnathan Ribeiro, Anton Kutepov, oscd.community, Chad Hudson, Matt Anderson
# Date: 2017-01-01
# Level: high
# Description: Detects certain command line parameters often used during reconnaissance activity via web shells
# MITRE Tactic: Persistence
# Tags: attack.persistence, attack.discovery, attack.t1505.003, attack.t1018, attack.t1033, attack.t1087

(ParentImage IN ("*-tomcat-*", "*\\tomcat*") ParentImage IN ("*\\java.exe", "*\\javaw.exe")) OR (CommandLine IN ("*catalina.jar*", "*CATALINA_HOME*") ParentImage IN ("*\\java.exe", "*\\javaw.exe")) OR ParentImage IN ("*\\w3wp.exe", "*\\php-cgi.exe", "*\\nginx.exe", "*\\httpd.exe", "*\\caddy.exe", "*\\ws_tomcatservice.exe") CommandLine IN ("*&cd&echo*", "*cd /d *") OR Image IN ("*\\dsquery.exe", "*\\find.exe", "*\\findstr.exe", "*\\ipconfig.exe", "*\\netstat.exe", "*\\nslookup.exe", "*\\pathping.exe", "*\\quser.exe", "*\\schtasks.exe", "*\\systeminfo.exe", "*\\tasklist.exe", "*\\tracert.exe", "*\\ver.exe", "*\\wevtutil.exe", "*\\whoami.exe") OR OriginalFileName IN ("dsquery.exe", "find.exe", "findstr.exe", "ipconfig.exe", "netstat.exe", "nslookup.exe", "pathping.exe", "quser.exe", "schtasks.exe", "sysinfo.exe", "tasklist.exe", "tracert.exe", "ver.exe", "VSSADMIN.EXE", "wevtutil.exe", "whoami.exe") OR CommandLine IN ("* Test-NetConnection *", "*dir \\*") OR (CommandLine IN ("* user *", "* use *", "* group *") OriginalFileName IN ("net.exe", "net1.exe")) OR (CommandLine="* -n *" OriginalFileName="ping.exe") OR (CommandLine IN ("* -enc *", "* -EncodedCommand *", "* -w hidden *", "* -windowstyle hidden*", "*.WebClient).Download*") Image IN ("*\\cmd.exe", "*\\powershell.exe", "*\\pwsh.exe")) OR (CommandLine="* /node:*" OriginalFileName="wmic.exe")