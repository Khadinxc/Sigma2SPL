# Title: PowerShell Base64 Encoded WMI Classes
# Author: Christian Burkard (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)
# Date: 2023-01-30
# Level: high
# Description: Detects calls to base64 encoded WMI class such as "Win32_ShadowCopy", "Win32_ScheduledJob", etc.
# MITRE Tactic: Execution
# Tags: attack.execution, attack.t1059.001, attack.defense-evasion, attack.t1027

Image IN ("*\\powershell.exe", "*\\pwsh.exe") OR OriginalFileName IN ("PowerShell.EXE", "pwsh.dll") CommandLine IN ("*VwBpAG4AMwAyAF8ATABvAGcAZwBlAGQATwBuAFUAcwBlAHIA*", "*cAaQBuADMAMgBfAEwAbwBnAGcAZQBkAE8AbgBVAHMAZQByA*", "*XAGkAbgAzADIAXwBMAG8AZwBnAGUAZABPAG4AVQBzAGUAcg*", "*V2luMzJfTG9nZ2VkT25Vc2Vy*", "*dpbjMyX0xvZ2dlZE9uVXNlc*", "*XaW4zMl9Mb2dnZWRPblVzZX*") OR CommandLine IN ("*VwBpAG4AMwAyAF8AUAByAG8AYwBlAHMAcw*", "*cAaQBuADMAMgBfAFAAcgBvAGMAZQBzAHMA*", "*XAGkAbgAzADIAXwBQAHIAbwBjAGUAcwBzA*", "*V2luMzJfUHJvY2Vzc*", "*dpbjMyX1Byb2Nlc3*", "*XaW4zMl9Qcm9jZXNz*") OR CommandLine IN ("*VwBpAG4AMwAyAF8AUwBjAGgAZQBkAHUAbABlAGQASgBvAGIA*", "*cAaQBuADMAMgBfAFMAYwBoAGUAZAB1AGwAZQBkAEoAbwBiA*", "*XAGkAbgAzADIAXwBTAGMAaABlAGQAdQBsAGUAZABKAG8AYg*", "*V2luMzJfU2NoZWR1bGVkSm9i*", "*dpbjMyX1NjaGVkdWxlZEpvY*", "*XaW4zMl9TY2hlZHVsZWRKb2*") OR CommandLine IN ("*VwBpAG4AMwAyAF8AUwBoAGEAZABvAHcAYwBvAHAAeQ*", "*cAaQBuADMAMgBfAFMAaABhAGQAbwB3AGMAbwBwAHkA*", "*XAGkAbgAzADIAXwBTAGgAYQBkAG8AdwBjAG8AcAB5A*", "*V2luMzJfU2hhZG93Y29we*", "*dpbjMyX1NoYWRvd2NvcH*", "*XaW4zMl9TaGFkb3djb3B5*") OR CommandLine IN ("*VwBpAG4AMwAyAF8AVQBzAGUAcgBBAGMAYwBvAHUAbgB0A*", "*cAaQBuADMAMgBfAFUAcwBlAHIAQQBjAGMAbwB1AG4AdA*", "*XAGkAbgAzADIAXwBVAHMAZQByAEEAYwBjAG8AdQBuAHQA*", "*V2luMzJfVXNlckFjY291bn*", "*dpbjMyX1VzZXJBY2NvdW50*", "*XaW4zMl9Vc2VyQWNjb3Vud*")