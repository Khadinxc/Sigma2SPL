# Title: Azure AD Health Monitoring Agent Registry Keys Access
# Author: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC
# Date: 2021-08-26
# Level: medium
# Description: This detection uses Windows security events to detect suspicious access attempts to the registry key of Azure AD Health monitoring agent.
# This detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object HKLM\SOFTWARE\Microsoft\Microsoft Online\Reporting\MonitoringAgent.
# MITRE Tactic: Discovery
# Tags: attack.discovery, attack.t1012

EventID IN (4656, 4663) ObjectName="\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Microsoft Online\\Reporting\\MonitoringAgent" ObjectType="Key" NOT (ProcessName IN ("*Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe*", "*Microsoft.Identity.Health.Adfs.InsightsService.exe*", "*Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe*", "*Microsoft.Identity.Health.Adfs.PshSurrogate.exe*", "*Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe*"))