# Title: Azure AD Health Service Agents Registry Keys Access
# Author: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research), MSTIC
# Date: 2021-08-26
# Level: medium
# Description: This detection uses Windows security events to detect suspicious access attempts to the registry key values and sub-keys of Azure AD Health service agents (e.g AD FS).
# Information from AD Health service agents can be used to potentially abuse some of the features provided by those services in the cloud (e.g. Federation).
# This detection requires an access control entry (ACE) on the system access control list (SACL) of the following securable object: HKLM:\SOFTWARE\Microsoft\ADHealthAgent.
# Make sure you set the SACL to propagate to its sub-keys.
# MITRE Tactic: Discovery
# Tags: attack.discovery, attack.t1012

EventID IN (4656, 4663) ObjectName="\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\ADHealthAgent" ObjectType="Key" NOT (ProcessName IN ("*Microsoft.Identity.Health.Adfs.DiagnosticsAgent.exe*", "*Microsoft.Identity.Health.Adfs.InsightsService.exe*", "*Microsoft.Identity.Health.Adfs.MonitoringAgent.Startup.exe*", "*Microsoft.Identity.Health.Adfs.PshSurrogate.exe*", "*Microsoft.Identity.Health.Common.Clients.ResourceMonitor.exe*"))