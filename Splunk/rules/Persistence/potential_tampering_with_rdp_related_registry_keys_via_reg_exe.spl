# Title: Potential Tampering With RDP Related Registry Keys Via Reg.EXE
# Author: pH-T (Nextron Systems), @Kostastsale, TheDFIRReport
# Date: 2022-02-12
# Level: high
# Description: Detects the execution of "reg.exe" for enabling/disabling the RDP service on the host by tampering with the 'CurrentControlSet\Control\Terminal Server' values
# MITRE Tactic: Persistence
# Tags: attack.persistence, attack.defense-evasion, attack.lateral-movement, attack.t1021.001, attack.t1112

CommandLine="* add *" CommandLine="*\\CurrentControlSet\\Control\\Terminal Server*" CommandLine="*REG_DWORD*" CommandLine="* /f*" Image="*\\reg.exe" OR OriginalFileName="reg.exe" (CommandLine="*Licensing Core*" CommandLine="*EnableConcurrentSessions*") OR CommandLine IN ("*WinStations\\RDP-Tcp*", "*MaxInstanceCount*", "*fEnableWinStation*", "*TSUserEnabled*", "*TSEnabled*", "*TSAppCompat*", "*IdleWinStationPoolCount*", "*TSAdvertise*", "*AllowTSConnections*", "*fSingleSessionPerUser*", "*fDenyTSConnections*")