# Title: Potential Active Directory Reconnaissance/Enumeration Via LDAP
# Author: Adeem Mawani
# Date: 2021-06-22
# Level: medium
# Description: Detects potential Active Directory enumeration via LDAP
# MITRE Tactic: Discovery
# Tags: attack.discovery, attack.t1069.002, attack.t1087.002, attack.t1482

(EventID=30 SearchFilter IN ("*(groupType:1.2.840.113556.1.4.803:=2147483648)*", "*(groupType:1.2.840.113556.1.4.803:=2147483656)*", "*(groupType:1.2.840.113556.1.4.803:=2147483652)*", "*(groupType:1.2.840.113556.1.4.803:=2147483650)*", "*(sAMAccountType=805306369)*", "*(sAMAccountType=805306368)*", "*(sAMAccountType=536870913)*", "*(sAMAccountType=536870912)*", "*(sAMAccountType=268435457)*", "*(sAMAccountType=268435456)*", "*(objectCategory=groupPolicyContainer)*", "*(objectCategory=organizationalUnit)*", "*(objectCategory=nTDSDSA)*", "*(objectCategory=server)*", "*(objectCategory=domain)*", "*(objectCategory=person)*", "*(objectCategory=group)*", "*(objectCategory=user)*", "*(objectClass=trustedDomain)*", "*(objectClass=computer)*", "*(objectClass=server)*", "*(objectClass=group)*", "*(objectClass=user)*", "*(primaryGroupID=521)*", "*(primaryGroupID=516)*", "*(primaryGroupID=515)*", "*(primaryGroupID=512)*", "*Domain Admins*", "*objectGUID=\**", "*(schemaIDGUID=\*)*", "*admincount=1*") NOT (EventID=30 SearchFilter IN ("*(domainSid=*)*", "*(objectSid=*)*"))) OR (EventID=30 SearchFilter IN ("*(userAccountControl:1.2.840.113556.1.4.803:=4194304)*", "*(userAccountControl:1.2.840.113556.1.4.803:=2097152)*", "*!(userAccountControl:1.2.840.113556.1.4.803:=1048574)*", "*(userAccountControl:1.2.840.113556.1.4.803:=524288)*", "*(userAccountControl:1.2.840.113556.1.4.803:=65536)*", "*(userAccountControl:1.2.840.113556.1.4.803:=8192)*", "*(userAccountControl:1.2.840.113556.1.4.803:=544)*", "*!(UserAccountControl:1.2.840.113556.1.4.803:=2)*", "*msDS-AllowedToActOnBehalfOfOtherIdentity*", "*msDS-AllowedToDelegateTo*", "*msDS-GroupManagedServiceAccount*", "*(accountExpires=9223372036854775807)*", "*(accountExpires=0)*", "*(adminCount=1)*", "*ms-MCS-AdmPwd*")) OR (DistinguishedName IN ("*CN=Domain Admins*", "*CN=Enterprise Admins*", "*CN=Group Policy Creator Owners*") EventID=30 SearchFilter="(objectclass=\*)")