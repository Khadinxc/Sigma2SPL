# Title: Access To Windows DPAPI Master Keys By Uncommon Applications
# Author: Nasreddine Bencherchali (Nextron Systems)
# Date: 2022-10-17
# Level: medium
# Description: Detects file access requests to the the Windows Data Protection API Master keys by an uncommon application.
# This can be a sign of credential stealing. Example case would be usage of mimikatz "dpapi::masterkey" function
# MITRE Tactic: Credential Access
# Tags: attack.credential-access, attack.t1555.004

FileName IN ("*\\Microsoft\\Protect\\S-1-5-18\\*", "*\\Microsoft\\Protect\\S-1-5-21-*") NOT (Image IN ("C:\\Program Files\\*", "C:\\Program Files (x86)\\*", "C:\\Windows\\system32\\*", "C:\\Windows\\SysWOW64\\*"))