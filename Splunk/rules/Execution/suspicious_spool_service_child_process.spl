# Title: Suspicious Spool Service Child Process
# Author: Justin C. (@endisphotic), @dreadphones (detection), Thomas Patzke (Sigma rule)
# Date: 2021-07-11
# Level: high
# Description: Detects suspicious print spool service (spoolsv.exe) child processes.
# MITRE Tactic: Execution
# Tags: attack.execution, attack.t1203, attack.privilege-escalation, attack.t1068

IntegrityLevel IN ("System", "S-1-16-16384") ParentImage="*\\spoolsv.exe" Image IN ("*\\gpupdate.exe", "*\\whoami.exe", "*\\nltest.exe", "*\\taskkill.exe", "*\\wmic.exe", "*\\taskmgr.exe", "*\\sc.exe", "*\\findstr.exe", "*\\curl.exe", "*\\wget.exe", "*\\certutil.exe", "*\\bitsadmin.exe", "*\\accesschk.exe", "*\\wevtutil.exe", "*\\bcdedit.exe", "*\\fsutil.exe", "*\\cipher.exe", "*\\schtasks.exe", "*\\write.exe", "*\\wuauclt.exe", "*\\systeminfo.exe", "*\\reg.exe", "*\\query.exe") OR (Image IN ("*\\net.exe", "*\\net1.exe") NOT CommandLine="*start*") OR (Image="*\\cmd.exe" NOT (CommandLine IN ("*.spl*", "*route add*", "*program files*"))) OR (Image="*\\netsh.exe" NOT (CommandLine IN ("*add portopening*", "*rule name*"))) OR (Image IN ("*\\powershell.exe", "*\\pwsh.exe") NOT CommandLine="*.spl*") OR (CommandLine="*rundll32.exe" Image="*\\rundll32.exe" OR OriginalFileName="RUNDLL32.EXE") | table Image,CommandLine