# Title: HackTool - CrackMapExec Execution
# Author: Florian Roth (Nextron Systems)
# Date: 2022-02-25
# Level: high
# Description: This rule detect common flag combinations used by CrackMapExec in order to detect its use even if the binary has been replaced.
# MITRE Tactic: Execution
# Tags: attack.execution, attack.persistence, attack.privilege-escalation, attack.credential-access, attack.discovery, attack.t1047, attack.t1053, attack.t1059.003, attack.t1059.001, attack.t1110, attack.t1201

Image="*\\crackmapexec.exe" OR (CommandLine="* --local-auth*" CommandLine="* -u *" CommandLine="* -x *") OR (CommandLine="* --local-auth*" CommandLine="* -u *" CommandLine="* -p *" CommandLine="* -H 'NTHASH'*") OR (CommandLine="* mssql *" CommandLine="* -u *" CommandLine="* -p *" CommandLine="* -M *" CommandLine="* -d *") OR (CommandLine="* smb *" CommandLine="* -u *" CommandLine="* -H *" CommandLine="* -M *" CommandLine="* -o *") OR (CommandLine="* smb *" CommandLine="* -u *" CommandLine="* -p *" CommandLine="* --local-auth*") OR CommandLine="* -M pe_inject *" OR (CommandLine="* --local-auth*" CommandLine="* -u *" CommandLine="* -p *" CommandLine="* 10.*" CommandLine="* 192.168.*" CommandLine="*/24 *") | table ComputerName,User,CommandLine