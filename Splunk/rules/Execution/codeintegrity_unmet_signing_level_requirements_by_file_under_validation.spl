# Title: CodeIntegrity - Unmet Signing Level Requirements By File Under Validation
# Author: Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)
# Date: 2022-01-20
# Level: low
# Description: Detects attempted file load events that did not meet the signing level requirements. It often means the file's signature is revoked or a signature with the Lifetime Signing EKU has expired.
# This event is best correlated with EID 3089 to determine the error of the validation.
# MITRE Tactic: Execution
# Tags: attack.execution
# False Positives:
#   - Antivirus and other third party products are known to trigger this rule quite a lot. Initial filters and tuning is required before using this rule.

EventID IN (3033, 3034) NOT (FileNameBuffer="*\\Windows\\assembly\\GAC\\*" ProcessNameBuffer="*\\Windows\\Microsoft.NET\\*" ProcessNameBuffer="*\\mscorsvw.exe" RequestedPolicy=8) NOT ((FileNameBuffer="*\\Windows\\System32\\DriverStore\\FileRepository\\*" FileNameBuffer="*\\igd10iumd64.dll" RequestedPolicy=7) OR (FileNameBuffer IN ("*\\Program Files\\Avast Software\\Avast\\aswAMSI.dll", "*\\Program Files (x86)\\Avast Software\\Avast\\aswAMSI.dll") RequestedPolicy IN (8, 12)) OR (FileNameBuffer="*\\Program Files\\Bonjour\\mdnsNSP.dll" ProcessNameBuffer IN ("*\\Windows\\System32\\svchost.exe", "*\\Windows\\System32\\SIHClient.exe") RequestedPolicy IN (8, 12)) OR FileNameBuffer="*\\Program Files\\comodo\\comodo internet security\\amsiprovider_x64.dll" OR (FileNameBuffer="*\\Program Files\\DTrace\\dtrace.dll" ProcessNameBuffer="*\\Windows\\System32\\svchost.exe" RequestedPolicy=12) OR (FileNameBuffer="*\\Windows\\System32\\nvspcap64.dll" ProcessNameBuffer IN ("*\\AppData\\Local\\Keybase\\Gui\\Keybase.exe", "*\\Microsoft\\Teams\\stage\\Teams.exe") RequestedPolicy=8) OR FileNameBuffer="*\\Program Files\\ESET\\ESET Security\\eamsi.dll" OR (FileNameBuffer IN ("*\\Mozilla Firefox\\mozavcodec.dll", "*\\Mozilla Firefox\\mozavutil.dll") ProcessNameBuffer="*\\Mozilla Firefox\\firefox.exe" RequestedPolicy=8) OR (FileNameBuffer="*\\Program Files\\Google\\Drive File Stream\\*" FileNameBuffer="*\\crashpad_handler.exe" ProcessNameBuffer="*\\Windows\\ImmersiveControlPanel\\SystemSettings.exe" RequestedPolicy=8) OR (ProcessNameBuffer="*\\Kaspersky Lab\\*" ProcessNameBuffer="*\\avp.exe*") OR (FileNameBuffer="*\\Kaspersky Lab\\*" FileNameBuffer="*\\antimalware_provider.dll*") OR FileNameBuffer IN ("*\\Program Files\\McAfee\\Endpoint Security\\Threat Prevention\\MfeAmsiProvider.dll", "*\\Program Files\\McAfee\\MfeAV\\AMSIExt.dll") OR FileNameBuffer="*\\Program Files\\National Instruments\\Shared\\mDNS Responder\\nimdnsNSP.dll " OR (FileNameBuffer="*\\Microsoft Office\\root\\vfs\\ProgramFilesCommonX64\\Microsoft Shared\\OFFICE*" FileNameBuffer="*\\MSOXMLMF.DLL" RequestedPolicy=7) OR FileNameBuffer="*\\National Instruments\\Shared\\mDNS Responder\\*" OR FileNameBuffer="*\\Program Files\\SentinelOne\\Sentinel Agent*" OR ProcessNameBuffer="*\\Program Files\\SentinelOne\\Sentinel Agent*" OR (FileNameBuffer="*\\Windows\\System32\\nvspcap64.dll" ProcessNameBuffer="*\\AppData\\Local\\slack\\app-*" ProcessNameBuffer="*\\slack.exe" RequestedPolicy=8) OR (FileNameBuffer="*\\Trend Micro\\Client Server Security Agent\\perficrcperfmonmgr.dll" RequestedPolicy=8))