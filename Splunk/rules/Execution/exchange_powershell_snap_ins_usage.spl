# Title: Exchange PowerShell Snap-Ins Usage
# Author: FPT.EagleEye, Nasreddine Bencherchali (Nextron Systems)
# Date: 2021-03-03
# Level: high
# Description: Detects adding and using Exchange PowerShell snap-ins to export mailbox data. As seen used by HAFNIUM and APT27
# MITRE Tactic: Execution
# Tags: attack.execution, attack.t1059.001, attack.collection, attack.t1114

CommandLine="*Add-PSSnapin*" Image IN ("*\\powershell.exe", "*\\pwsh.exe") OR OriginalFileName IN ("PowerShell.EXE", "pwsh.dll") CommandLine IN ("*Microsoft.Exchange.Powershell.Snapin*", "*Microsoft.Exchange.Management.PowerShell.SnapIn*") NOT (CommandLine="*$exserver=Get-ExchangeServer ([Environment]::MachineName) -ErrorVariable exerr 2> $null*" ParentImage="C:\\Windows\\System32\\msiexec.exe")