# Title: Office Application Initiated Network Connection To Non-Local IP
# Author: Christopher Peacock '@securepeacock', SCYTHE '@scythe_io', Florian Roth (Nextron Systems), Tim Shelton, Nasreddine Bencherchali (Nextron Systems)
# Date: 2021-11-10
# Level: medium
# Description: Detects an office application (Word, Excel, PowerPoint)  that initiate a network connection to a non-private IP addresses.
# This rule aims to detect traffic similar to one seen exploited in CVE-2021-42292.
# This rule will require an initial baseline and tuning that is specific to your organization.
# MITRE Tactic: Execution
# Tags: attack.execution, attack.t1203
# False Positives:
#   - You may have to tune certain domains out that Excel may call out to, such as microsoft or other business use case domains.
#   - Office documents commonly have templates that refer to external addresses, like "sharepoint.ourcompany.com" may have to be tuned.
#   - It is highly recommended to baseline your activity and tune out common business use cases.

Image IN ("*\\excel.exe", "*\\outlook.exe", "*\\powerpnt.exe", "*\\winword.exe", "*\\wordview.exe") Initiated="true" NOT ((DestinationHostname="*.deploy.static.akamaitechnologies.com" DestinationPort=443 Protocol="tcp") OR DestinationIp="127.0.0.0/8" OR DestinationIp="10.0.0.0/8" OR DestinationIp="172.16.0.0/12" OR DestinationIp="192.168.0.0/16" OR DestinationIp="169.254.0.0/16" OR DestinationIp="::1/128" OR DestinationIp="fe80::/10" OR DestinationIp="fc00::/7" OR (DestinationIp="13.107.4.0/22" OR DestinationIp="13.107.6.152/31" OR DestinationIp="13.107.18.10/31" OR DestinationIp="13.107.42.0/23" OR DestinationIp="13.107.128.0/22" OR DestinationIp="23.35.224.0/20" OR DestinationIp="23.53.40.0/22" OR DestinationIp="23.103.160.0/20" OR DestinationIp="23.216.76.0/22" OR DestinationIp="40.96.0.0/13" OR DestinationIp="40.104.0.0/15" OR DestinationIp="52.96.0.0/14" OR DestinationIp="131.253.33.215/32" OR DestinationIp="132.245.0.0/16" OR DestinationIp="150.171.32.0/22" OR DestinationIp="204.79.197.215/32" OR DestinationIp="2603:1006::/40" OR DestinationIp="2603:1016::/36" OR DestinationIp="2603:1026::/36" OR DestinationIp="2603:1036::/36" OR DestinationIp="2603:1046::/36" OR DestinationIp="2603:1056::/36" OR DestinationIp="2620:1ec:4::152/128" OR DestinationIp="2620:1ec:4::153/128" OR DestinationIp="2620:1ec:c::10/128" OR DestinationIp="2620:1ec:c::11/128" OR DestinationIp="2620:1ec:d::10/128" OR DestinationIp="2620:1ec:d::11/128" OR DestinationIp="2620:1ec:8f0::/46" OR DestinationIp="2620:1ec:900::/46" OR DestinationIp="2620:1ec:a92::152/128" OR DestinationIp="2620:1ec:a92::153/128" DestinationPort IN (80, 443)) OR (DestinationIp="13.107.6.152/31" OR DestinationIp="13.107.18.10/31" OR DestinationIp="13.107.128.0/22" OR DestinationIp="23.103.160.0/20" OR DestinationIp="40.96.0.0/13" OR DestinationIp="40.104.0.0/15" OR DestinationIp="52.96.0.0/14" OR DestinationIp="131.253.33.215/32" OR DestinationIp="132.245.0.0/16" OR DestinationIp="150.171.32.0/22" OR DestinationIp="204.79.197.215/32" OR DestinationIp="2603:1006::/40" OR DestinationIp="2603:1016::/36" OR DestinationIp="2603:1026::/36" OR DestinationIp="2603:1036::/36" OR DestinationIp="2603:1046::/36" OR DestinationIp="2603:1056::/36" OR DestinationIp="2620:1ec:4::152/128" OR DestinationIp="2620:1ec:4::153/128" OR DestinationIp="2620:1ec:c::10/128" OR DestinationIp="2620:1ec:c::11/128" OR DestinationIp="2620:1ec:d::10/128" OR DestinationIp="2620:1ec:d::11/128" OR DestinationIp="2620:1ec:8f0::/46" OR DestinationIp="2620:1ec:900::/46" OR DestinationIp="2620:1ec:a92::152/128" OR DestinationIp="2620:1ec:a92::153/128" DestinationPort IN (143, 587, 993, 995) Protocol="tcp") OR (DestinationIp="40.92.0.0/15" OR DestinationIp="40.107.0.0/16" OR DestinationIp="52.100.0.0/14" OR DestinationIp="52.238.78.88/32" OR DestinationIp="104.47.0.0/17" OR DestinationIp="2a01:111:f400::/48" OR DestinationIp="2a01:111:f403::/48" DestinationPort=443) OR (DestinationIp="40.92.0.0/15" OR DestinationIp="40.107.0.0/16" OR DestinationIp="52.100.0.0/14" OR DestinationIp="52.238.78.88/32" OR DestinationIp="104.47.0.0/17" OR DestinationIp="2a01:111:f400::/48" OR DestinationIp="2a01:111:f403::/48" DestinationPort=25) OR DestinationIp="2.16.56.0/23" OR DestinationIp="2.17.248.0/21" OR DestinationIp="13.107.240.0/21" OR DestinationIp="20.184.0.0/13" OR DestinationIp="23.61.224.0/20" OR DestinationIp="20.192.0.0/10" OR DestinationIp="23.72.0.0/13" OR DestinationIp="23.3.88.0/22" OR DestinationIp="23.216.132.0/22" OR DestinationIp="40.76.0.0/14" OR DestinationIp="51.10.0.0/15" OR DestinationIp="51.103.0.0/16" OR DestinationIp="51.104.0.0/15" OR DestinationIp="51.142.136.0/22" OR DestinationIp="52.160.0.0/11" OR DestinationIp="95.101.96.0/21" OR DestinationIp="204.79.197.0/24" OR (DestinationIp="13.107.6.171/32" OR DestinationIp="13.107.18.15/32" OR DestinationIp="13.107.140.6/32" OR DestinationIp="20.64.0.0/10" OR DestinationIp="52.108.0.0/14" OR DestinationIp="52.244.37.168/32" OR DestinationIp="2603:1006:1400::/40" OR DestinationIp="2603:1016:2400::/40" OR DestinationIp="2603:1026:2400::/40" OR DestinationIp="2603:1036:2400::/40" OR DestinationIp="2603:1046:1400::/40" OR DestinationIp="2603:1056:1400::/40" OR DestinationIp="2603:1063:2000::/38" OR DestinationIp="2620:1ec:c::15/128" OR DestinationIp="2620:1ec:8fc::6/128" OR DestinationIp="2620:1ec:a92::171/128" OR DestinationIp="2a01:111:f100:2000::a83e:3019/128" OR DestinationIp="2a01:111:f100:2002::8975:2d79/128" OR DestinationIp="2a01:111:f100:2002::8975:2da8/128" OR DestinationIp="2a01:111:f100:7000::6fdd:6cd5/128" OR DestinationIp="2a01:111:f100:a004::bfeb:88cf/128" DestinationPort IN (80, 443) Protocol="tcp") OR (DestinationIp="172.128.0.0/10" OR DestinationIp="20.20.32.0/19" OR DestinationIp="20.103.156.88/32" OR DestinationIp="20.190.128.0/18" OR DestinationIp="20.231.128.0/19" OR DestinationIp="40.126.0.0/18" OR DestinationIp="57.150.0.0/15" OR DestinationIp="2603:1006:2000::/48" OR DestinationIp="2603:1007:200::/48" OR DestinationIp="2603:1016:1400::/48" OR DestinationIp="2603:1017::/48" OR DestinationIp="2603:1026:3000::/48" OR DestinationIp="2603:1027:1::/48" OR DestinationIp="2603:1036:3000::/48" OR DestinationIp="2603:1037:1::/48" OR DestinationIp="2603:1046:2000::/48" OR DestinationIp="2603:1047:1::/48" OR DestinationIp="2603:1056:2000::/48" OR DestinationIp="2603:1057:2::/48" DestinationPort IN (80, 443) Protocol="tcp") OR (DestinationIp="13.64.0.0/11" OR DestinationIp="13.107.6.192/32" OR DestinationIp="13.107.9.192/32" OR DestinationIp="13.89.179.14/32" OR DestinationIp="20.40.0.0/14" OR DestinationIp="20.48.0.0/12" OR DestinationIp="20.64.0.0/12" OR DestinationIp="52.123.0.0/16" OR DestinationIp="52.108.0.0/14" OR DestinationIp="52.136.0.0/13" OR DestinationIp="57.150.0.0/15" OR DestinationIp="80.239.150.67/32" OR DestinationIp="2620:1ec:4::192/128" OR DestinationIp="2620:1ec:a92::192/128" DestinationPort=443 Protocol="tcp") OR (DestinationIp="13.107.136.0/22" OR DestinationIp="40.108.128.0/17" OR DestinationIp="52.104.0.0/14" OR DestinationIp="104.146.128.0/17" OR DestinationIp="150.171.40.0/22" OR DestinationIp="2603:1061:1300::/40" OR DestinationIp="2620:1ec:8f8::/46" OR DestinationIp="2620:1ec:908::/46" OR DestinationIp="2a01:111:f402::/48" DestinationPort IN (80, 443) Protocol="tcp"))