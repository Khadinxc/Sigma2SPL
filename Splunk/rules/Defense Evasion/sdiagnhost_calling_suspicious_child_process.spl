# Title: Sdiagnhost Calling Suspicious Child Process
# Author: Nextron Systems, @Kostastsale
# Date: 2022-06-01
# Level: high
# Description: Detects sdiagnhost.exe calling a suspicious child process (e.g. used in exploits for Follina / CVE-2022-30190)
# MITRE Tactic: Defense Evasion
# Tags: attack.defense-evasion, attack.t1036, attack.t1218

Image IN ("*\\powershell.exe", "*\\pwsh.exe", "*\\cmd.exe", "*\\mshta.exe", "*\\cscript.exe", "*\\wscript.exe", "*\\taskkill.exe", "*\\regsvr32.exe", "*\\rundll32.exe", "*\\calc.exe") ParentImage="*\\sdiagnhost.exe" NOT ((CommandLine="*bits*" Image="*\\cmd.exe") OR (CommandLine IN ("*-noprofile -", "*-noprofile") Image="*\\powershell.exe"))